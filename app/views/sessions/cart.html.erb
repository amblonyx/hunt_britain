<% provide(:title, "Shopping cart") %>

<h1>Shopping Cart</h1>
<div class="row">
	<div class="span10 offset1">
	
		<% if @cart.length == 0 %>
			<!-- ########## Cart is empty ########## -->
			Your shopping cart is empty.<br/>
			<%= link_to "Continue shopping", root_path %>
		
		<% else %>
			<!-- ########## Cart is NOT empty ########## -->
			
			<% if @action == "checkout" %>
				<% if !@user.guest? %>
					Name: <%= @user.name %><br/>
				<% end %>
				Email: <%= @user.email %><br/>
				<%= output_phone(@user.phone) %><br/>
				
				<% if has_purchase_format(@cart, "Paper") %>
					<p><strong>Paper hunts will be sent to:</strong><br/>
					<%= output_address(@user) %></p>
				<% end %>
				
				<% if has_purchase_format(@cart, "Online") %>
					<p><strong>PDFs and Links to the online hunt will be sent to:</strong><br/>
					<%= @user.email %></p>
				<% end %>
			<% end %>

			<%= form_tag("/update_cart", id: "updateCartForm", method: "put") do %>

				<table class="table table-bordered table-striped">
					<thead>
						<tr>
							<% if @action == "cart" %>
								<th>Product Name</th>
								<th colspan="2">Quantity</th>
								<th>Price per unit</th>
								<th>Total Price</th>
								<th></th>
							<% else %>
								<th>Product Name</th>
								<th>Quantity</th>
								<th>Price per unit</th>
								<th>Total Price</th>
							<% end %>
						</tr>
					</thead>
					<tbody>
						<% total_price = 0 %>
						
						<% @cart.each do |cart_item| %>
							<% product = Product.find(cart_item[:product_id]) %>
							<% total_price += product.price * cart_item[:num].to_f %>
							<tr>
								<td><%= product.name %></td>
								<% if @action == "cart" %>
									<td class="merge-right">
										<%= text_field_tag "product[" + cart_item[:product_id] + "]", cart_item[:num], class: "input-small" %>
									</td>
									<td class="merge-left">
										<%= submit_tag "Update", class: "btn" %>
									</td>
								<% else %>
									<td><%= cart_item[:num] %></td>
								<% end %>
								<td>£<%= "%.2f" % (product.price) %></td>
								<td>£<%= "%.2f" % (cart_item[:num].to_f * product.price) %></td>
								<% if @action == "cart" %>
									<td><%= link_to "Remove", remove_from_cart_path(product_id: product.id), method: :post %></td>
								<% end %>
							</tr>
						<% end %>
						<tr> 
							<% if @action == "cart" %>
								<td colspan="4"><strong>Grand Total:</strong></td>
								<td>£<%= "%.2f" % (total_price) %></td>
								<td></td>
							<% else %>
								<td colspan="3"><strong>Grand Total:</strong></td>
								<td>£<%= "%.2f" % (total_price) %></td>							
							<% end %>
						</tr>
					<tbody>
				</table>				
			<% end %>

			<div class="pull-right">
				<%= link_to "Continue shopping", root_path, class: "btn" %>
				
				<% if @action == "cart" %>
					<%= link_to "Checkout", checkout_path, class: "btn btn-primary" %>
				<% else %>
					<%= link_to "Pay with Paypal", @paypal_link, class: "btn btn-primary" %>
				<% end %>
			</div>
			
			<% if Rails.env.development? %>	
				<div class="well">
					<strong>Development console:</strong><br/>
					<% if @action == "cart" %>
					<% else %>
						<%= link_to "Create Purchase", @test_link, method: :post %>		
					<% end %>
				</div>
			<% end %>
		<% end %>
	</div>
</div>


